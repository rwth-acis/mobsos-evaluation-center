<mat-card id="header-card">
  <!-- service selection -->
  <mat-toolbar-row>
    <mat-form-field id="community-service-select">
      <mat-label>{{
        'success-modeling.select-application' | translate
      }}</mat-label>
      <mat-select
        [(ngModel)]="selectedService"
        (selectionChange)="onServiceSelected($event.value)"
      >
        <mat-option
          *ngFor="let service of services$ | async"
          [value]="service"
        >
          {{ service.alias ? service.alias : service.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
  </mat-toolbar-row>
  <!-- workspace management -->
  <mat-toolbar-row
    id="edit-controls"
    *ngIf="showWorkSpaceManagementControls$ | async"
  >
    <mat-slide-toggle
      labelPosition="before"
      [checked]="editMode$ | async"
      (toggleChange)="onEditModeToggled()"
      [disabled]="!(memberOfGroup$ | async)"
      [matTooltip]="
        (memberOfGroup$ | async)
          ? ('success-modeling.edit-tooltip' | translate)
          : ('success-modeling.edit-disabled-tooltip' | translate)
      "
    >
      {{ 'success-modeling.edit-mode-toggle' | translate }}
    </mat-slide-toggle>

    <div id="workspace-controls" *ngIf="editMode$ | async">
      <ng-container *ngIf="visitors$ | async as visitors">
        <button
          mat-icon-button
          aria-label="Spectators"
          [matMenuTriggerFor]="groupMenu"
          matTooltip="{{
            'success-modeling.visitors.tooltip' | translate
          }}"
        >
          <mat-icon
            color="primary"
            [matBadge]="
              visitors?.length === 0 ? null : visitors?.length
            "
            matBadgeColor="accent"
          >
            group
          </mat-icon>
        </button>
      </ng-container>
      <button
        mat-icon-button
        aria-label="Workspaces"
        [matMenuTriggerFor]="workspaceMenu"
        matTooltip="{{
          'success-modeling.workspaces.tooltip' | translate
        }}"
      >
        <mat-icon
          color="primary"
          [matBadge]="
            (workspacesForServiceExceptActive$ | async)?.length === 0
              ? null
              : (workspacesForServiceExceptActive$ | async)?.length
          "
          matBadgeColor="accent"
        >
          view_carousel
        </mat-icon>
      </button>

      <button
        *ngIf="userIsOwner$ | async"
        mat-icon-button
        aria-label="Workspaces"
        (click)="shareWorkspaceLink()"
        matTooltip="{{
          'success-modeling.workspaces.share-workspace' | translate
        }}"
      >
        <mat-icon color="primary"> share </mat-icon>
      </button>
    </div>
  </mat-toolbar-row>
</mat-card>

<ng-container
  *ngIf="(user$ | async)?.profile?.preferred_username as username"
>
  <mat-card *ngIf="editMode$ | async" id="workspace-info">
    <div
      id="info-content"
      *ngIf="applicationWorkspaceOwner$ | async as owner"
    >
      <mat-icon color="accent">info_outline</mat-icon>
      <span id="info-text">
        <span
          *ngIf="
            userIsOwner$ | async;
            else notOwnerInCurrentWorkspace
          "
        >
          {{ 'success-modeling.info.own-workspace' | translate }}
        </span>
      </span>
    </div>
  </mat-card>
</ng-container>

<!-- menu for visitors -->
<mat-menu #groupMenu>
  <ng-container *ngIf="visitors$ | async as visitors">
    <mat-card-content class="card">
      <h3>{{ 'success-modeling.visitors.heading' | translate }}</h3>
      <div *ngIf="visitors?.length === 0" class="popover-row">
        {{ 'success-modeling.visitors.no-visitors' | translate }}
      </div>
      <mat-list role="list">
        <mat-list-item
          *ngFor="let visitor of visitors"
          role="listitem"
        >
          <div id="visitor">
            <span>{{ visitor.username }}</span>

            <span *ngIf="userIsOwner$ | async">
              <ng-container [ngSwitch]="visitor.role">
                <button
                  *ngSwitchCase="'spectator'"
                  mat-icon-button
                  matTooltip="{{
                    'success-modeling.visitors.edit-role-description'
                      | translate
                  }}"
                  matTooltipShowDelay="0"
                  (click)="
                    onChangeRole(visitor.username, 'editor', $event)
                  "
                >
                  <mat-icon>create</mat-icon>
                </button>
                <button
                  *ngSwitchCase="'editor'"
                  mat-icon-button
                  matTooltip="{{
                    'success-modeling.visitors.spectator-role-description'
                      | translate
                  }}"
                  matTooltipShowDelay="0"
                  (click)="
                    onChangeRole(
                      visitor.username,
                      'spectator',
                      $event
                    )
                  "
                >
                  <mat-icon>remove_red_eye</mat-icon>
                </button>
              </ng-container>
            </span>
          </div></mat-list-item
        >
      </mat-list>
    </mat-card-content>
  </ng-container>
</mat-menu>
<!-- menu for workspace -->
<mat-menu #workspaceMenu>
  <ng-container
    *ngIf="
      workspacesForServiceExceptActive$ | async as other_workspaces
    "
  >
    <mat-card-content class="card">
      <h3>{{ 'success-modeling.workspaces.heading' | translate }}</h3>
      <div *ngIf="other_workspaces?.length === 0">
        {{ 'success-modeling.workspaces.no-workspaces' | translate }}
      </div>
      <div
        *ngFor="let workspace of other_workspaces"
        class="popover-row"
      >
        <span>
          {{ workspace.createdBy }}
          <strong
            *ngIf="
              workspace.createdBy ===
              (user$ | async)?.profile.preferred_username
            "
          >
            ({{
              'success-modeling.workspaces.your-workspace'
                | translate
            }})
          </strong>
        </span>
        <span>
          <button
            *ngIf="userIsOwner$ | async"
            mat-icon-button
            matTooltip="{{
              'success-modeling.workspaces.copy-workspace' | translate
            }}"
            matTooltipShowDelay="0"
            (click)="openCopyWorkspaceDialog(workspace.createdBy)"
          >
            <mat-icon>content_copy</mat-icon>
          </button>
          <button
            mat-icon-button
            matTooltip="{{
              'success-modeling.workspaces.go-to' | translate
            }}"
            matTooltipShowDelay="0"
            (click)="onSwitchWorkspace(workspace.createdBy)"
          >
            <mat-icon>exit_to_app</mat-icon>
          </button>
        </span>
      </div>
    </mat-card-content>
  </ng-container>
</mat-menu>

<ng-template #notOwnerInCurrentWorkspace>
  <ng-contiainer *ngIf="roleInWorkspace$ | async as role">
    {{ 'success-modeling.info.workspace-of' | translate }}
    <strong>{{ applicationWorkspaceOwner$ | async }}</strong
    >.
    <span *ngIf="role === 'spectator'">
      {{
        'success-modeling.info.workspace-rights-spectator' | translate
      }}
    </span>
    <span *ngIf="role === 'editor'">
      {{
        'success-modeling.info.workspace-rights-editor' | translate
      }}
    </span>
    {{
      'success-modeling.info.workspace-ask-owner-to-save' | translate
    }}
  </ng-contiainer>
</ng-template>
